--- 
title: "Ravelry Table"
author: "Alex McSween"
format: 
  dashboard:
    logo: images/logo.png
    nav-buttons: 
     - icon: github
       href: https://github.com/alexmcsw/ravelry-table
     - icon: activity
       href: https://www.ravelry.com/people/amcsw
    theme: 
        light: minty
---

```{r}
library(ravelRy)
library(dplyr)
library(gt)
library(purrr)
library(tidyr)


hot_right_now <- search_patterns(page_size = 25)

# Step 1: Fetch top 25 patterns
top_patterns <- search_patterns(page_size = 25) |>
  mutate(rank = 1:25)

# Step 2: Get detailed info for each pattern
pattern_details <- get_patterns(top_patterns$id)

# Step 3: Assemble dataframe
pattern_df <- pattern_details |>
  select(
    favorites_count,
    free,
    id,
    name,
    permalink,
    projects_count,
    published,
    gauge,
    gauge_divisor,
    gauge_pattern,
    yarn_weight_description,
    yardage_description,
    photos
  ) |>
  mutate(photos = map(photos, pluck, "square_url", 1)) |>
  unnest(photos) |>
  merge(top_patterns |> select(id, designer.name, rank), by = "id") |>
  arrange(rank) |>
  mutate(
    across(
      c(id, favorites_count, projects_count, gauge, gauge_divisor),
      as.numeric
    ),
    permalink = paste0("ravelry.com/", permalink),
    across(where(is.character), ~ na_if(., ""))
  )


pattern_df |>
  select(
    photos,
    name,
    permalink,
    designer.name,
    yarn_weight_description,
    gauge,
    gauge_divisor,
    gauge_pattern,
    yardage_description,
    projects_count,
    favorites_count
  ) |>
  gt() |>
  text_transform(
    locations = cells_body(columns = photos),
    fn = function(x) {
      web_image(
        url = x,
        height = 100
      )
    }
  ) |>
  fmt_url(
    columns = permalink,
    label = "Ravelry"
  ) |>
  cols_add(heart = "Heart", project = "mitten") |>
  fmt_icon(heart, fill_color = "red", stroke_color = "red") |>
  fmt_icon(project, fill_color = "blue", stroke_color = "blue") |>
  cols_merge(
    columns = c(name, permalink),
    pattern = "{1} ({2})"
  ) |>
  cols_merge(
    columns = c(favorites_count, heart, projects_count, project),
    pattern = "{2} {1} {4} {3}"
  ) |>
  cols_merge(
    columns = c(gauge, gauge_divisor, gauge_pattern),
    pattern = "{1} sts in {2} inches <<({3})>>"
  ) |>
  cols_label(
    photos = "",
    name = "pattern",
    designer.name = "Designer",
    yarn_weight_description = "Yarn Weight",
    gauge = "Gauge",
    yardage_description = "Yardage Range",
    favorites_count = ""
  ) |>
  cols_width(
    photos ~ px(150),
    name ~ px(150),
    everything() ~ px(100)
  ) |>
  opt_stylize(color = "pink") |>
  tab_options(
    table.width = pct(90),
    container.overflow.y = FALSE
  )



```