
```{r}
library(ravelRy)
library(dplyr)
library(gt)
library(purrr)
library(tidyr)


hot_yesterday <- read.csv("./data/hot_yesterday.csv")

hot_right_now <- search_patterns(page_size = 20)

# Step 1: Fetch top 25 patterns
top_patterns <- search_patterns(page_size = 20) |>
  mutate(rank = 1:20)

# Step 2: Get detailed info for each pattern
pattern_details <- get_patterns(top_patterns$id)

# Step 3: Assemble dataframe
pattern_df <- pattern_details |>
  select(
    favorites_count,
    free,
    id,
    name,
    permalink,
    projects_count,
    published,
    gauge,
    gauge_divisor,
    gauge_pattern,
    yarn_weight_description,
    photos,
    craft
  ) |>
  mutate(photos = map(photos, pluck, "small_url", 1)) |>
  unnest(photos) |>
  mutate(craft = map(craft, pluck, "name", 1)) |>
  unnest(craft) |>
  merge(top_patterns |> select(id, designer.name, rank), by = "id") |>
  arrange(rank) |>
  mutate(
    across(
      c(id, favorites_count, projects_count, gauge, gauge_divisor),
      as.numeric
    ),
    permalink = paste0("ravelry.com/patterns/library/", permalink),
    across(where(is.character), ~ na_if(., ""))
  )

```


```{r}

pattern_df |>
  merge(
    hot_yesterday,
    by = c("id", "name"),
    suffixes = c("","_yesterday"),
    all.x = TRUE
  ) |>
  select(
    photos,
    name,
    permalink,
    designer.name,
    craft,
    gauge,
    gauge_divisor,
    yarn_weight_description,
    projects_count,
    favorites_count,
    rank,
    rank_yesterday
  ) |>
  mutate(
    change = case_when(
      rank - rank_yesterday > 0 ~ "arrow-up",
      rank - rank_yesterday < 0 ~ "arrow-down",
      .default = NA
    ),
    .keep = "unused",
    .before = photos
  ) |>
  gt() |>
    text_transform(
    locations = cells_body(columns = photos),
    fn = function(x) {
      lapply(x, function(url) {
        html(paste0(
          "<div style='width:150px; height:150px; overflow:hidden; display:inline-block; border:2px solid white;'>",
          "<img src='", url, "' style='width:300px; height:150px; object-fit:cover;'>",
          "</div>"
        ))
      })
    }
  ) |>
  fmt_icon(
    columns = change,
    fill_color = c("arrow-up" = "#128800ff", "arrow-down" = "#c50101ff",
    height = "1.5em")
  ) |>
  cols_merge(
    columns = c(name, permalink),
    pattern = "<a href='{2}' target='_blank'>{1}</a>"
  ) |>
  fmt_markdown(
    columns = name
  ) |>
  cols_add(
    favourites = "./static/favourites.svg",
    projects = "./static/needles.svg") |>
  text_transform(
    locations = cells_body(columns = favourites),
    fn = function(x) {
      mapply(function(img, val) {
        html(paste0(
          "<div style='display:flex; align-items:center; gap:10px;'>",
          as.character(local_image(img, height = 30)),
          "<span>", val, "</span>",
          "</div>"
        ))
      }, x, pattern_df$favorites_count, SIMPLIFY = FALSE)
    }
  ) |>
  text_transform(
    locations = cells_body(columns = projects),
    fn = function(x) {
      mapply(function(img, val) {
        html(paste0(
          "<div style='display:flex; align-items:center; gap:10px;'>",
          as.character(local_image(img, height = 30)),
          "<span>", val, "</span>",
          "</div>"
        ))
      }, x, pattern_df$projects_count, SIMPLIFY = FALSE)
    }
  ) |>
  cols_hide(columns = c(projects_count, favorites_count))|>
  cols_merge(
    columns = c(gauge, gauge_divisor),
    pattern = "<<{1} sts / {2} in>>"
  ) |>
  cols_width(
    photos ~ pct(20),
    name ~ pct(15),
    change ~ pct(2),
    designer.name ~ pct(15),
    craft ~ pct(10),
    gauge ~ pct(15),
    yarn_weight_description ~ pct(15),
    favourites ~ pct(5),
    projects ~ pct(5),
  ) |>
    cols_align(
    align = "left",
    columns = everything()
  ) |>
    cols_align(
    align = "center",
    columns = c("photos", "favourites", "projects")
  ) |>
  cols_label(
    photos = "",
    name = md("**Pattern**"),
    change = "",
    designer.name = md("**Designer**"),
    yarn_weight_description = md("**Weight**"),
    gauge = md("**Gauge**"),
    favourites = "",
    projects = "",
    craft = md("**Craft**")
  ) |>
  sub_missing(
    columns = everything(),
    rows = everything(),
    missing_text = ""
  ) |>
    tab_options(
    table.background.color = "#1E1F26",
    table.font.size = px(16),
    table.border.top.color = "transparent",
    table.border.bottom.color = "transparent",
    table_body.hlines.color = "transparent",
    table_body.border.bottom.color = "transparent",
    column_labels.border.bottom.color = "transparent",
    column_labels.border.top.color = "transparent",
    footnotes.background.color = "#CDD4DC",
    source_notes.background.color = "#CDD4DC"
  ) |> 
  tab_style_body(
    style = cell_borders(
      sides = c("top", "bottom"),
      weight = px(0) # Remove row borders
    ),
    fn = function(x) { is.numeric(x) | is.character(x) }
  ) |> 
  opt_css(
    css = "
    table tr:nth-child(odd) {
      background-color: var(--brand-slate);
    }

    table tr:hover {
      background-color: #3A4A6B;
    }

    .cell-output-display {
      overflow-x: unset !important;
    }
    
    div#custom {
      overflow-x: unset !important;
      overflow-y: unset !important;
    }
    
    #custom .gt_col_heading {
      position: sticky !important;
      top: -5px !important;
      z-index: 10 !important;
    }
    "
  )



```

```{r}

write.csv(pattern_df |> select(id, name, rank) |> mutate(date = Sys.Date()), "data/hot_yesterday.csv", row.names = FALSE)

```