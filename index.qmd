
```{r get-data}
library(ravelRy)
library(dplyr)
library(gt)
library(purrr)
library(tidyr)
library(stringr)


hot_yesterday <- read.csv("./data/hot_yesterday.csv")

# grab top 25 patterns, 
# check for knit/crochet alongs to remove,
# then reduce total count to top 20
top_patterns <- search_patterns(page_size = 25) |>
  filter(!str_detect(name, regex(str_c(c("kal", "kal", "along"), collapse = "|"), ignore_case = TRUE))) |>
  slice_head(n = 20) |>
  mutate(rank = 1:20)

# grab full pattern details
pattern_details <- get_patterns(top_patterns$id)

# assemble df
pattern_df <- 

pattern_details |>
  select(
    favorites_count,
    id,
    name,
    permalink,
    projects_count,
    published,
    gauge,
    gauge_divisor,
    gauge_pattern,
    yarn_weight_description,
    photos,
    craft,
    free
  ) |>
  mutate(
    photos_small = map(photos, pluck, "small_url", 1),
    photos_large = str_replace(photos_small, "_small_best_fit", "")
  ) |>
  mutate(craft = map(craft, pluck, "name", 1)) |>
  unnest(craft) |>
  merge(top_patterns |> select(id, designer.name, rank), by = "id") |>
  arrange(rank) |>
  mutate(
    across(
      c(id, favorites_count, projects_count, gauge, gauge_divisor),
      as.numeric
    ),
    permalink = paste0("www.ravelry.com/patterns/library/", permalink),
    across(where(is.character), ~ na_if(., ""))
  ) |>
mutate(photos = paste0(
  "<a href='", photos_large, "' data-lightbox='ravelry-gallery", id, "'>",
  "<img src='", photos_small, "' style='width:150px; height:150px; object-fit:cover; border:2px solid white;'>",
  "</a>"
))




```


```{r make-table}

pattern_df |>
  merge(
    hot_yesterday,
    by = c("id", "name"),
    suffixes = c("","_yesterday"),
    all.x = TRUE
  ) |>
  select(
    photos,
    name,
    permalink,
    designer.name,
    craft,
    gauge,
    gauge_divisor,
    yarn_weight_description,
    projects_count,
    favorites_count,
    rank,
    rank_yesterday
  ) |>
  mutate(
    change = case_when(
      rank - rank_yesterday < 0 ~ "arrow-up",
      rank - rank_yesterday > 0 ~ "arrow-down",
      .default = NA
    ),
    .before = photos
  ) |>
  arrange(rank) |>
  gt() |>
  fmt_markdown(columns = photos) |>
  fmt_icon(
    columns = change,
    fill_color = c("arrow-up" = "#128800ff", "arrow-down" = "#c50101ff",
    height = "1.5em")
  ) |>
  cols_merge(
    columns = c(name, permalink),
    pattern = "<a href='{2}' target='_blank'>{1}</a>"
  ) |>
  fmt_markdown(
    columns = name
  ) |>
  cols_add(
    favourites = "./static/favourites.svg",
    projects = "./static/needles.svg") |>
  text_transform(
    locations = cells_body(columns = favourites),
    fn = function(x) {
      mapply(function(img, val) {
        html(paste0(
          "<div style='display:flex; align-items:center; gap:10px;'>",
          as.character(local_image(img, height = 30)),
          "<span>", val, "</span>",
          "</div>"
        ))
      }, x, pattern_df$favorites_count, SIMPLIFY = FALSE)
    }
  ) |>
  text_transform(
    locations = cells_body(columns = projects),
    fn = function(x) {
      mapply(function(img, val) {
        html(paste0(
          "<div style='display:flex; align-items:center; gap:10px;'>",
          as.character(local_image(img, height = 30)),
          "<span>", val, "</span>",
          "</div>"
        ))
      }, x, pattern_df$projects_count, SIMPLIFY = FALSE)
    }
  ) |>
  cols_hide(columns = c(projects_count, favorites_count, rank, rank_yesterday))|>
  cols_merge(
    columns = c(gauge, gauge_divisor),
    pattern = "<<{1} sts / {2} in>>"
  ) |>
  cols_width(
    photos ~ pct(12),
    name ~ pct(15),
    change ~ pct(5),
    designer.name ~ pct(15),
    craft ~ pct(12),
    gauge ~ pct(15),
    yarn_weight_description ~ pct(15),
    favourites ~ pct(5),
    projects ~ pct(5)
  ) |>
    cols_align(
    align = "left",
    columns = everything()
  ) |>
    cols_align(
    align = "center",
    columns = c("photos", "favourites", "projects", "change")
  ) |>
  cols_label(
    photos = "",
    name = md("**Pattern**"),
    change = "",
    designer.name = md("**Designer**"),
    yarn_weight_description = md("**Weight**"),
    gauge = md("**Gauge**"),
    favourites = "",
    projects = "",
    craft = md("**Craft**")
  ) |>
  sub_missing(
    columns = everything(),
    rows = everything(),
    missing_text = ""
  ) |>
    tab_options(
    table.background.color = "#1E1F26",
    table.font.size = px(16),
    table.border.top.color = "transparent",
    table.border.bottom.color = "transparent",
    table_body.hlines.color = "transparent",
    table_body.border.bottom.color = "transparent",
    column_labels.border.bottom.color = "transparent",
    column_labels.border.top.color = "transparent",
    table.margin.right = pct(1)
  ) |> 
  tab_style_body(
    style = cell_borders(
      sides = c("top", "right", "left", "bottom"),
      weight = px(0) # Remove row borders
    ),
    fn = function(x) { is.numeric(x) | is.character(x) }
  ) |> 
  opt_css(
    css = "
    table tr:nth-child(odd) {
      background-color: var(--brand-slate);
    }

    table tr:hover {
      background-color: #3A4A6B;
    }
    
    .gt_col_heading {
      position: sticky !important;
      top: 0px !important;
      z-index: 10 !important;
    }
    "
  )



```

```{r write-history}

write.csv(pattern_df |> select(id, name, rank) |> mutate(date = Sys.Date()), "data/hot_yesterday.csv", row.names = FALSE)

```